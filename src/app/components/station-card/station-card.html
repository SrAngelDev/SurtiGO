<article
  (mouseenter)="onMouseEnter()"
  (mouseleave)="onMouseLeave()"
  class="group relative rounded-2xl border transition-all duration-300 cursor-pointer"
  [class]="isActive()
    ? 'border-brand-blue/40 bg-brand-blue/5 shadow-lg shadow-brand-blue/5'
    : 'border-glass-border bg-glass hover:border-dark-border-hover hover:bg-glass-hover'"
>
  <!-- Rank badge -->
  @if (isTop3()) {
    <div class="absolute -top-2 -left-2 z-10 flex h-7 w-7 items-center justify-center rounded-lg text-xs font-bold shadow-md"
      [class]="rank() === 1 ? 'bg-brand-orange text-white' : rank() === 2 ? 'bg-zinc-400 text-zinc-900' : 'bg-amber-700 text-amber-100'">
      {{ rank() }}
    </div>
  }

  <!-- Main row (clickable) -->
  <div class="flex items-center gap-4 p-3.5" (click)="toggleExpand()">
    <!-- Price Block -->
    <div class="flex shrink-0 flex-col items-center justify-center rounded-xl px-3 py-2 min-w-18"
      [class]="isCheap() ? 'bg-brand-orange/10' : 'bg-dark-card dark:bg-dark-card'">
      @if (currentPrice(); as price) {
        <span class="text-xl font-extrabold tabular-nums leading-none" [class]="isCheap() ? 'text-brand-orange' : 'text-text-primary'">
          {{ price.toFixed(3) }}
        </span>
        <span class="mt-0.5 text-[10px] font-medium text-text-muted">EUR/L</span>
      } @else {
        <span class="text-base font-semibold text-text-muted">N/D</span>
        <span class="mt-0.5 text-[10px] text-text-muted">sin datos</span>
      }
    </div>

    <!-- Info -->
    <div class="min-w-0 flex-1">
      <div class="flex items-center gap-2">
        <h3 class="truncate text-sm font-semibold text-text-primary leading-snug">
          {{ station().nombre }}
        </h3>
        @if (station().marca) {
          <span class="inline-flex shrink-0 items-center rounded-md bg-dark-card px-1.5 py-0.5 text-[10px] font-semibold uppercase tracking-wider text-text-secondary">
            {{ station().marca }}
          </span>
        }
        @if (isCheap()) {
          <span class="inline-flex shrink-0 items-center gap-0.5 rounded-md bg-brand-green/10 px-1.5 py-0.5 text-[10px] font-bold uppercase tracking-wider text-brand-green">
            Ahorro
          </span>
        }
      </div>
      <p class="mt-0.5 truncate text-xs text-text-muted">
        @if (station().direccion) {
          {{ station().direccion }}
          @if (station().localidad || station().provincia) {
            <span class="text-dark-border-hover"> · </span>
          }
        }
        @if (station().localidad) {
          {{ station().localidad }}
        }
        @if (station().localidad && station().provincia) {
          <span class="text-dark-border-hover"> · </span>
        }
        @if (station().provincia) {
          {{ station().provincia }}
        }
      </p>

      <!-- Bottom row -->
      <div class="mt-1.5 flex items-center gap-3">
        @if (formattedDistance(); as dist) {
          <span class="inline-flex items-center gap-1 text-[11px] text-text-secondary">
            <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"/><circle cx="12" cy="10" r="3"/>
            </svg>
            {{ dist }}
          </span>
        }
        @if (savingsVsAvg(); as savings) {
          <span class="inline-flex items-center gap-0.5 text-[11px] font-medium text-brand-green">
            <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="m6 9 6 6 6-6"/>
            </svg>
            Ahorras {{ savings.toFixed(2) }} EUR/dep
          </span>
        }
      </div>
    </div>

    <!-- Expand chevron -->
    <svg class="h-4 w-4 shrink-0 text-text-muted transition-transform duration-200"
      [class]="expanded() ? 'rotate-90' : ''"
      viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="m9 18 6-6-6-6"/>
    </svg>
  </div>

  <!-- Expanded detail panel -->
  @if (expanded()) {
    <div class="border-t border-glass-border px-3.5 pb-3.5 pt-3 animate-slide-down">
      <!-- All prices grid -->
      @if (allPrices().length > 0) {
        <div class="mb-3 grid grid-cols-2 gap-2 sm:grid-cols-3">
          @for (p of allPrices(); track p.label) {
            <div class="rounded-lg bg-dark-card p-2 text-center">
              <div class="text-[10px] font-medium uppercase tracking-wider text-text-muted">{{ p.label }}</div>
              <div class="mt-0.5 text-sm font-bold tabular-nums text-text-primary">{{ p.value.toFixed(3) }}</div>
            </div>
          }
        </div>
      }

      <!-- Schedule -->
      @if (station().horario) {
        <div class="mb-3 flex items-start gap-2 text-xs text-text-secondary">
          <svg class="mt-0.5 h-3.5 w-3.5 shrink-0 text-text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
          </svg>
          <span>{{ station().horario }}</span>
        </div>
      }

      <!-- Navigation buttons -->
      <div class="flex flex-wrap gap-2">
        <button (click)="openNavigation('google'); $event.stopPropagation()"
          class="inline-flex items-center gap-1.5 rounded-lg bg-brand-blue/10 px-3 py-1.5 text-xs font-medium text-brand-blue transition-colors hover:bg-brand-blue/20">
          <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 11l19-9-9 19-2-8-8-2z"/>
          </svg>
          Google Maps
        </button>
        <button (click)="openNavigation('waze'); $event.stopPropagation()"
          class="inline-flex items-center gap-1.5 rounded-lg bg-brand-blue/10 px-3 py-1.5 text-xs font-medium text-brand-blue transition-colors hover:bg-brand-blue/20">
          <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 11l19-9-9 19-2-8-8-2z"/>
          </svg>
          Waze
        </button>
        <button (click)="openNavigation('apple'); $event.stopPropagation()"
          class="inline-flex items-center gap-1.5 rounded-lg bg-brand-blue/10 px-3 py-1.5 text-xs font-medium text-brand-blue transition-colors hover:bg-brand-blue/20">
          <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 11l19-9-9 19-2-8-8-2z"/>
          </svg>
          Apple Maps
        </button>
      </div>
    </div>
  }
</article>
