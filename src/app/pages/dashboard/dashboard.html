<div class="flex h-[calc(100dvh-3.25rem)] flex-col">

  <!-- ────── Toolbar ────── -->
  <div class="shrink-0 border-b border-glass-border bg-dark-bg/80 backdrop-blur-lg">
    <div class="mx-auto flex max-w-screen-2xl flex-col gap-3 px-4 py-3 sm:px-6">

      <!-- Row 1: Fuel type + View mode -->
      <div class="flex flex-wrap items-center justify-between gap-3">
        <!-- Fuel toggle -->
        <div class="flex items-center gap-0.5 rounded-xl border border-glass-border bg-glass p-1 overflow-x-auto">
          @for (option of fuelOptions; track option.value) {
            <button
              (click)="selectFuelType(option.value)"
              [class]="fuelService.selectedFuelType() === option.value
                ? 'bg-brand-blue text-white shadow-sm'
                : 'text-text-muted hover:text-text-secondary'"
              class="shrink-0 rounded-lg px-3 py-1.5 text-xs sm:text-sm font-medium transition-all duration-200">
              {{ option.icon }} {{ option.label }}
            </button>
          }
        </div>

        <!-- View mode toggle -->
        <div class="flex items-center rounded-xl border border-glass-border bg-glass p-1">
          <button (click)="setViewMode('split')"
            [class]="viewMode() === 'split' ? 'bg-dark-card-hover text-text-primary shadow-sm' : 'text-text-muted hover:text-text-secondary'"
            class="hidden rounded-lg px-3 py-1.5 text-xs font-medium transition-all lg:flex items-center gap-1.5">
            <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="3" x2="12" y2="21"/></svg>
            Split
          </button>
          <button (click)="setViewMode('list')"
            [class]="viewMode() === 'list' ? 'bg-dark-card-hover text-text-primary shadow-sm' : 'text-text-muted hover:text-text-secondary'"
            class="flex items-center gap-1.5 rounded-lg px-3 py-1.5 text-xs font-medium transition-all">
            <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
            Lista
          </button>
          <button (click)="setViewMode('map')"
            [class]="viewMode() === 'map' ? 'bg-dark-card-hover text-text-primary shadow-sm' : 'text-text-muted hover:text-text-secondary'"
            class="flex items-center gap-1.5 rounded-lg px-3 py-1.5 text-xs font-medium transition-all">
            <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="6" x2="15" y2="21"/></svg>
            Mapa
          </button>
        </div>
      </div>

      <!-- Row 2: Radius slider + Stats -->
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="w-full max-w-xs">
          <app-radius-slider
            [value]="searchRadius()"
            [min]="5"
            [max]="50"
            [step]="5"
            (valueChange)="onRadiusChange($event)"
          />
        </div>
        <app-stats-bar class="hidden sm:block" />
      </div>
    </div>
  </div>

  <!-- ────── Location warning (non-blocking) ────── -->
  @if (geoService.locationError()) {
    <div class="shrink-0 flex items-center justify-between gap-3 border-b border-yellow-500/20 bg-yellow-500/5 px-4 py-2 sm:px-6">
      <p class="text-xs text-yellow-500/80">
        <span class="font-medium">Sin GPS:</span> Mostrando resultados por defecto (Madrid).
      </p>
      <button (click)="retryLocation()" class="shrink-0 text-xs font-medium text-yellow-500 underline decoration-yellow-500/30 underline-offset-2 hover:decoration-yellow-500">
        Reintentar
      </button>
    </div>
  }

  <!-- ────── API error ────── -->
  @if (fuelService.error(); as apiError) {
    <div class="shrink-0 flex items-center gap-2 border-b border-red-500/20 bg-red-500/5 px-4 py-2 sm:px-6">
      <svg class="h-4 w-4 shrink-0 text-red-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
      <p class="text-xs text-red-400">{{ apiError }}</p>
    </div>
  }

  <!-- ────── Main Content Area ────── -->
  @if (geoService.isLocating() || fuelService.isLoading()) {
    <!-- Loading -->
    <div class="flex flex-1 flex-col items-center justify-center gap-4">
      <div class="relative">
        <div class="h-10 w-10 animate-spin rounded-full border-[3px] border-dark-border border-t-brand-blue"></div>
      </div>
      <p class="text-sm text-text-muted animate-pulse">
        {{ geoService.isLocating() ? 'Localizando...' : 'Cargando estaciones...' }}
      </p>
    </div>
  } @else if (fuelService.sortedStations().length === 0 && !fuelService.error()) {
    <!-- Empty -->
    <div class="flex flex-1 flex-col items-center justify-center gap-3 px-4">
      <div class="flex h-16 w-16 items-center justify-center rounded-2xl bg-dark-card">
        <svg class="h-8 w-8 text-text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 22V5a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v17"/><path d="M13 10h2a2 2 0 0 1 2 2v2a2 2 0 0 0 2 2 2 2 0 0 0 2-2V9.83a2 2 0 0 0-.59-1.42L18 6"/><path d="M3 22h10"/><path d="M5 8h6"/>
        </svg>
      </div>
      <p class="text-sm font-medium text-text-secondary">No se encontraron estaciones en este radio</p>
      <p class="text-xs text-text-muted">Prueba a ampliar el radio de b&#250;squeda</p>
    </div>
  } @else {
    <!-- Content -->
    <div class="flex-1 overflow-hidden" [class]="viewMode() === 'map' ? '' : 'flex'">

      <!-- ── List Panel ── -->
      @if (viewMode() !== 'map') {
        <div
          class="overflow-y-auto"
          [class]="viewMode() === 'split' ? 'w-full lg:w-[420px] lg:shrink-0 lg:border-r lg:border-glass-border' : 'w-full'">
          <div
            class="p-4 sm:p-5"
            [class]="viewMode() === 'list' ? 'mx-auto max-w-screen-xl' : ''">

            <!-- Mobile stats (only list mode) -->
            <app-stats-bar class="mb-4 sm:hidden" />

            <div [class]="viewMode() === 'list'
              ? 'grid grid-cols-1 gap-3 sm:grid-cols-2 xl:grid-cols-3'
              : 'flex flex-col gap-2'">
              @for (station of fuelService.sortedStations(); track station.idEstacion; let i = $index) {
                <app-station-card
                  [station]="station"
                  [averagePrice]="fuelService.averagePrice()"
                  [rank]="i + 1"
                  [isActive]="highlightedStation()?.idEstacion === station.idEstacion"
                  (stationHover)="onStationHover($event)"
                  (stationSelect)="onStationSelect($event)"
                  style="animation-delay: {{ i * 30 }}ms"
                  class="animate-slide-up"
                />
              }
            </div>
          </div>
        </div>
      }

      <!-- ── Map Panel ── -->
      @if (viewMode() !== 'list') {
        <div class="flex-1 relative" [class]="viewMode() === 'map' ? 'h-full' : 'hidden lg:block'">
          <app-map-view
            [stations]="fuelService.sortedStations()"
            [userLocation]="geoService.userLocation()"
            [highlightedStation]="highlightedStation()"
            (stationClicked)="onStationHover($event)"
            (locationChange)="onMapLocationChange($event)"
          />
        </div>
      }
    </div>
  }
</div>
